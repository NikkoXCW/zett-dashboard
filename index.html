<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volvo BEV Trial Data</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f4f4f4; text-align: center; }
        .value-container { text-align: left; max-width: 800px; margin: auto; }
        .value-box { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .value-box label { font-weight: bold; white-space: nowrap; }
        .value-box span { font-size: 18px; font-weight: bold; color: #63973F; }
        .filter-container { margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; cursor: pointer; }
        th { background-color: #f4f4f4; }
        .chart-container { display: none; position: fixed; top: 10%; left: 10%; width: 80%; height: 60%; background: white; padding: 20px; border: 1px solid #ddd; }
        .close-btn { cursor: pointer; font-size: 20px; }
    </style>
</head>
<body>
    <h2>ZETT - Volvo BEV Trial - Sutco</h2>
    <div class="value-container">
        <div class="value-box">
            <label for="trialStartDate">Trial Operation Start Date:</label>
            <span id="trialStartDate">January 29, 2025</span>
        </div>
        <div class="value-box">
            <label for="cellA3">Operating Days:</label>
            <span id="cellA3"></span>
        </div>
        <div class="value-box">
            <label for="cellJ3">Total Net Loads (Kg):</label>
            <span id="cellJ3"></span>
        </div>
        <div class="value-box">
            <label for="cellK3">Total Operating Mileage (Km):</label>
            <span id="cellK3"></span>
        </div>
        <div class="value-box">
            <label for="cellP3">Average Fuel Consumption Rate (kWh/Km):</label>
            <span id="cellP3"></span>
        </div>
        <div class="value-box">
            <label for="cellQ3">Average Energy Efficiency 1 (CAD$/Km):</label>
            <span id="cellQ3"></span>
        </div>
        <div class="value-box">
            <label for="cellR3">Average Energy Efficiency 2 (CAD$/Km):</label>
            <span id="cellR3"></span>
        </div>
        <div class="value-box">
            <label for="cellS3">CO2 Emission Reduction (Kg):</label>
            <span id="cellS3"></span>
        </div>
    </div>
    <div class="filter-container">
        <label for="startDate">Start Date:</label>
        <input type="date" id="startDate">
        <label for="endDate">End Date:</label>
        <input type="date" id="endDate">
        <button onclick="filterData()">Filter</button>
    </div>
    <table>
        <thead>
            <tr id="tableHeader"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
    <div class="chart-container" id="chartPopup">
        <span class="close-btn" onclick="closeChart()">&times;</span>
        <canvas id="trendChart"></canvas>
    </div>
    <script>
        const apiKey = 'AIzaSyC8f4hfYHPD8ZjffE2BlmCbEAmkgVJQsOQ';
        const sheetId = '1Tw-3NfzRG7JhzLsjLBfrRF__Plo4BZS8RWRa-csbiH4';
        
        // Separate ranges for value boxes and table data
        const valueBoxRange = 'VolvoBEV!A3:S3'; // Fetch value box data (first few columns)
        const tableRange = 'VolvoBEV!A5:AB'; // Fetch table data (entire table)
        
        let sheetData = [];
        let valueBoxData = [];
        
        // Fetch value box data
        async function fetchValueBoxData() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${valueBoxRange}?key=${apiKey}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.values) {
                    valueBoxData = data.values; // Store value box data
                    populateValueBoxes(valueBoxData[0]); // Populate value boxes with the first row of value box data
                }
            } catch (error) {
                console.error('Error fetching value box data:', error);
            }
        }

        // Fetch table data
        async function fetchTableData() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${tableRange}?key=${apiKey}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.values) {
                    sheetData = data.values; // Store table data
                    renderTable(sheetData); // Render the table with the selected columns
                }
            } catch (error) {
                console.error('Error fetching table data:', error);
            }
        }

        // Populate value boxes with data
        function populateValueBoxes(row) {
            document.getElementById('cellA3').innerText = row[0] || '';
            document.getElementById('cellJ3').innerText = row[9] || '';
            document.getElementById('cellK3').innerText = row[10] || '';
            document.getElementById('cellP3').innerText = row[15] || '';
            document.getElementById('cellQ3').innerText = row[16] || '';
            document.getElementById('cellR3').innerText = row[17] || '';
            document.getElementById('cellS3').innerText = row[18] || '';
        }

        // Define the columns you want to show (indexes are based on Google Sheet columns)
        const selectedColumns = [0, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18]; // Example columns to display (A, J, K, L, M, N, O, P, Q, R, S)

        // Define corresponding column names for the header based on selected columns
        const columnNames = ["Date", "Cargo Loads Net (Kg)", "Mileage (Km)", "Operating Time (h:mm:ss)", "Average Speed (Km/h)", "Battery SoC (Trip Start)", "Battery SoC (Trip End)", "Fuel Consumption (kWh/Km)", "Energy Efficiency 1 ($/Km)", "Energy Efficiency 2 ($/Km)", "CO2 Reduction (Kg)"];

        // Render the table with the filtered data
        function renderTable(data) {
            const tableHeader = document.getElementById("tableHeader");
            const tableBody = document.getElementById("tableBody");
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';

            // Create table headers based on selected columns
            columnNames.forEach((col, index) => {
                const th = document.createElement("th");
                th.innerText = col;
                th.onclick = () => showTrend(col);
                tableHeader.appendChild(th);
            });

            // Render table rows with only the selected columns
            data.forEach(row => {
                const tr = document.createElement("tr");
                selectedColumns.forEach(colIndex => {
                    const td = document.createElement("td");
                    td.innerText = row[colIndex] || ''; // Display the data from the selected columns
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }

        // Function to filter the data based on date range
        function filterData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            const filteredData = sheetData.filter(row => {
                const rowDate = new Date(row[0]); // Assuming the first column contains the date
                return (!startDate || rowDate >= new Date(startDate)) && (!endDate || rowDate <= new Date(endDate));
            });

            renderTable(filteredData);
        }

        // Function to show the trend chart when a column header is clicked
        function showTrend(column) {
            const chartContainer = document.getElementById("chartPopup");
            const chartCanvas = document.getElementById("trendChart");
            chartContainer.style.display = "block";

            const columnIndex = columnNames.indexOf(column);

            if (columnIndex === -1) return; // Handle invalid column index

            // Collecting data for the trend chart (Y values)
            const trendData = sheetData.map(row => {
                const value = parseFloat(row[columnIndex]);
                return isNaN(value) ? null : value; // Return null for invalid numbers
            }).filter(value => value !== null); // Filter out null values

            // Collecting dates for the X axis
            const dates = sheetData.map(row => row[0]); // Dates are in the first column

            const chart = new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels: dates.slice(0, trendData.length), // Slice to match the number of trend data points
                    datasets: [{
                        label: column,
                        data: trendData,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        fill: false,
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { type: 'category' }, // Set the X-axis to be based on categorical data (dates)
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Close the trend chart popup
        function closeChart() {
            document.getElementById("chartPopup").style.display = "none";
        }

        // Fetch both value box and table data
        fetchValueBoxData();
        fetchTableData();
    </script>
</body>
</html>
